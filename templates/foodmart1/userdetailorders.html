{% extends "foodmart1/userprofile.html" %}
{% block main %}
    <h1 class="dashboard-title">Dashboard</h1>

    <!-- Recent Orders -->
    <div class="recent-orders">
        <table id="ordersTable" class="orders-table">
            <thead>
            <tr>
                <th>Order ID</th>
                <th>Product Id</th>
                <th>Amount</th>
                <th>Totall Price</th>
            </tr>
            </thead>
            <tbody>
            {% for o in orders %}
            <tr>
                <td>{{ o.id }}</td>
                <td>{{ o.product_id }}</td>
                <td>{{ o.amount }}</td>
                <td>${{ o.price }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>

        <!-- Pagination Controls -->
        <div id="paginationControls" class="pagination-controls" style="margin-top:1rem; display:flex; align-items:center; gap:0.75rem;">
            <label for="rowsPerPage">Rows:</label>
            <select id="rowsPerPage" aria-label="Rows per page">
                <option value="5">5</option>
                <option value="10" selected>10</option>
                <option value="25">25</option>
                <option value="50">50</option>
            </select>

            <button id="prevPage" type="button" aria-label="Previous page">Prev</button>

            <div id="pageButtons" style="display:inline-flex; gap:0.25rem;"></div>

            <button id="nextPage" type="button" aria-label="Next page">Next</button>

            <div id="pageInfo" style="margin-left:auto; font-size:0.9rem;"></div>
        </div>
    </div>
{% endblock %}

{% block js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const table = document.getElementById('ordersTable');
    if (!table) return;

    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    const rowsPerPageSelect = document.getElementById('rowsPerPage');
    const prevBtn = document.getElementById('prevPage');
    const nextBtn = document.getElementById('nextPage');
    const pageButtonsContainer = document.getElementById('pageButtons');
    const pageInfo = document.getElementById('pageInfo');

    let currentPage = 1;
    let rowsPerPage = parseInt(rowsPerPageSelect.value, 10) || 10;

    function calcTotalPages() {
        return Math.max(1, Math.ceil(rows.length / rowsPerPage));
    }

    function renderPage(page) {
        const totalPages = calcTotalPages();
        if (page < 1) page = 1;
        if (page > totalPages) page = totalPages;
        currentPage = page;

        // hide all rows, then show the current page
        rows.forEach((r, i) => {
            const start = (currentPage - 1) * rowsPerPage;
            const end = start + rowsPerPage;
            r.style.display = (i >= start && i < end) ? '' : 'none';
        });

        renderPageButtons();
        updateNavState();
        updatePageInfo();
    }

    function renderPageButtons() {
        pageButtonsContainer.innerHTML = '';
        const totalPages = calcTotalPages();

        // show a compact set of page buttons:
        // if pages <= 7 show all, otherwise use window around currentPage
        const maxButtons = 7;
        let start = 1;
        let end = totalPages;

        if (totalPages > maxButtons) {
            const side = Math.floor((maxButtons - 1) / 2);
            start = Math.max(1, currentPage - side);
            end = Math.min(totalPages, currentPage + side);
            if (start === 1) end = maxButtons;
            if (end === totalPages) start = totalPages - (maxButtons - 1);
        }

        if (start > 1) {
            pageButtonsContainer.appendChild(makePageButton(1));
            if (start > 2) pageButtonsContainer.appendChild(makeEllipsis());
        }

        for (let p = start; p <= end; p++) {
            pageButtonsContainer.appendChild(makePageButton(p));
        }

        if (end < totalPages) {
            if (end < totalPages - 1) pageButtonsContainer.appendChild(makeEllipsis());
            pageButtonsContainer.appendChild(makePageButton(totalPages));
        }
    }

    function makePageButton(pageNumber) {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = pageNumber;
        btn.setAttribute('aria-label', 'Go to page ' + pageNumber);
        btn.dataset.page = pageNumber;
        btn.style.minWidth = '2rem';
        btn.style.padding = '.25rem .5rem';
        if (pageNumber === currentPage) {
            btn.disabled = true;
            btn.style.fontWeight = '700';
        }
        btn.addEventListener('click', () => renderPage(pageNumber));
        return btn;
    }

    function makeEllipsis() {
        const span = document.createElement('span');
        span.textContent = 'â€¦';
        span.style.padding = '.25rem .5rem';
        span.setAttribute('aria-hidden', 'true');
        return span;
    }

    function updateNavState() {
        const totalPages = calcTotalPages();
        prevBtn.disabled = currentPage <= 1;
        nextBtn.disabled = currentPage >= totalPages;
    }

    function updatePageInfo() {
        const totalPages = calcTotalPages();
        const start = rows.length === 0 ? 0 : (currentPage - 1) * rowsPerPage + 1;
        const end = Math.min(rows.length, currentPage * rowsPerPage);
        pageInfo.textContent = `Showing ${start}-${end} of ${rows.length} (${totalPages} page${totalPages>1 ? 's' : ''})`;
    }

    // event listeners
    prevBtn.addEventListener('click', () => renderPage(currentPage - 1));
    nextBtn.addEventListener('click', () => renderPage(currentPage + 1));
    rowsPerPageSelect.addEventListener('change', () => {
        rowsPerPage = parseInt(rowsPerPageSelect.value, 10) || 10;
        renderPage(1);
    });

    // initial render
    renderPage(1);

    // Optional: if your table rows might change dynamically later (e.g. via AJAX),
    // you can call `updateRows()` to refresh the internal rows list and re-render.
    window.ordersTablePagination = {
        updateRows: function () {
            // re-collect rows and re-render preserving currentPage if possible
            const newRows = Array.from(tbody.querySelectorAll('tr'));
            // replace content of rows array while keeping reference
            rows.length = 0;
            Array.prototype.push.apply(rows, newRows);
            if (currentPage > calcTotalPages()) currentPage = calcTotalPages();
            renderPage(currentPage);
        }
    };
});
</script>
{% endblock %}